<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Breastfeeding Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; color: #111; }
    h1 { font-size: 1.5rem; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    label { display: block; font-weight: 600; margin-top: 8px; }
    input { width: 100%; padding: 10px; font-size: 1rem; margin-top: 4px; }
    button { padding: 10px 14px; font-size: 1rem; border-radius: 10px; border: 1px solid #111; background: #111; color: #fff; }
    button.secondary { background: #fff; color: #111; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 0.95rem; }
    .event { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    .muted { color: #6b7280; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Breastfeeding Tracker</h1>

  <div class="card">
    <h2>Add Feeding</h2>
    <label>Breast</label>
    <div class="row">
      <button class="secondary" id="breastL" onclick="setBreast('L')">L</button>
      <button class="secondary" id="breastR" onclick="setBreast('R')">R</button>
    </div>
    <div id="breastHint" class="muted" style="margin-top:6px;">Selected: <strong id="breastSelected">L</strong></div>

    <label>Start</label>
    <div class="row">
      <input type="datetime-local" id="start" />
      <button class="secondary" onclick="setNow('start')">Now</button>
    </div>

    <label>End</label>
    <div class="row">
      <input type="datetime-local" id="end" />
      <button class="secondary" onclick="setNow('end')">Now</button>
    </div>

    <div style="margin-top:12px;">
      <button onclick="addEvent()">Save</button>
    </div>
    <div id="error" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <h2>Last 7 Days Summary</h2>
    <div id="summary" class="summary"></div>
  </div>

  <div class="card">
    <h2>Recent Feedings</h2>
    <div id="events"></div>
  </div>

<script>
  const pad = (n) => String(n).padStart(2, '0');
  const fmtLocal = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;

  function setNow(id) {
    document.getElementById(id).value = fmtLocal(new Date());
  }

  let breast = 'L';

  function setBreast(side) {
    breast = side;
    document.getElementById('breastSelected').textContent = side;
    // lightweight visual state
    document.getElementById('breastL').style.borderColor = (side === 'L') ? '#111' : '#e5e7eb';
    document.getElementById('breastR').style.borderColor = (side === 'R') ? '#111' : '#e5e7eb';
  }

  async function addEvent() {
    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;
    const error = document.getElementById('error');
    error.textContent = '';
    if (!start || !end) {
      error.textContent = 'Start and end are required.';
      return;
    }
    const res = await fetch('/api/feeds', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ breast, start, end })
    });
    if (!res.ok) {
      const data = await res.json();
      error.textContent = data.detail || 'Error saving feeding.';
      return;
    }
    document.getElementById('start').value = '';
    document.getElementById('end').value = '';
    await load();
  }

  async function deleteEvent(id) {
    await fetch(`/api/feeds/${id}`, { method: 'DELETE' });
    await load();
  }

  function durationMinutes(start, end) {
    const s = new Date(start);
    const e = new Date(end);
    return Math.max(0, Math.round((e - s) / 60000));
  }

  async function load() {
    const [eventsRes, summaryRes] = await Promise.all([
      fetch('/api/feeds?days=7'),
      fetch('/api/summary?days=7')
    ]);
    const events = await eventsRes.json();
    const summary = await summaryRes.json();

    const eventsEl = document.getElementById('events');
    eventsEl.innerHTML = '';
    events.forEach(ev => {
      const div = document.createElement('div');
      div.className = 'event';
      div.innerHTML = `
        <div>
          <div><strong>${ev.breast}</strong> · <strong>${new Date(ev.start).toLocaleString()}</strong> → ${new Date(ev.end).toLocaleString()}</div>
          <div class="muted">Duration: ${ev.duration_minutes} min</div>
        </div>
        <button class="secondary" onclick="deleteEvent(${ev.id})">Delete</button>
      `;
      eventsEl.appendChild(div);
    });

    const summaryEl = document.getElementById('summary');
    summaryEl.innerHTML = '';
    // Summaries come back as (day, breast) tuples. Render as a 2-row block per day.
    const byDay = {};
    summary.forEach(s => {
      byDay[s.day] = byDay[s.day] || {};
      byDay[s.day][s.breast] = s;
    });

    Object.keys(byDay).sort().reverse().forEach(day => {
      const sL = byDay[day]['L'] || { count: 0, total_minutes: 0 };
      const sR = byDay[day]['R'] || { count: 0, total_minutes: 0 };
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div><strong>${day}</strong></div>
        <div class="muted">L: ${sL.count} feeds · ${sL.total_minutes} min</div>
        <div class="muted">R: ${sR.count} feeds · ${sR.total_minutes} min</div>
      `;
      summaryEl.appendChild(div);
    });
  }

  setBreast('L');
  load();
</script>
</body>
</html>
